<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StockTrendAI - Smart Stock Market Analyzer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --success-color: #2ecc71;
      --danger-color: #e74c3c;
      --background-dark: #1a1a1a;
      --card-bg: #2d2d2d;
      --text-bright: #ffffff;
      --text-dim: #a0a0a0;
      --text-highlight: #4fc3f7;
    }

    body {
      background-color: var(--background-dark);
      color: var(--text-bright);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    .fade-out {
      opacity: 0;
      transition: opacity 0.8s ease;
    }

    .fade-in {
      opacity: 1;
      transition: opacity 0.8s ease;
    }

    #stock-section {
      display: none;
      opacity: 0;
    }

    .navbar {
      background-color: var(--primary-color) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card {
      background-color: var(--card-bg);
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .form-control::placeholder {
      color: var(--text-dim);
      opacity: 0.7;
    }

    .form-control, .form-select {
      background-color: #3d3d3d;
      border: 1px solid #4d4d4d;
      color: var(--text-bright);
      font-size: 1.1rem;
    }

    .form-label {
      color: var(--text-bright);
      font-weight: 500;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .stock-suggestions {
      position: absolute;
      width: 100%;
      background: #3d3d3d;
      border: 1px solid #4d4d4d;
      border-radius: 0.375rem;
      margin-top: 2px;
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
    }

    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      color: var(--text-bright);
    }

    .suggestion-item:hover {
      background-color: var(--primary-color);
    }

    .suggestion-symbol {
      font-weight: bold;
      color: var(--secondary-color);
    }

    .suggestion-name {
      color: var(--text-dim);
      font-size: 0.9rem;
      margin-left: 8px;
    }

    .btn-primary {
      background-color: var(--secondary-color);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }

    .time-selector .btn-link {
      color: #ffffff;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .time-selector .btn-link:hover {
      background-color: rgba(52, 152, 219, 0.2);
    }

    .chart-container {
      background-color: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .chart-wrapper {
      position: relative;
      height: 220px;
      width: 100%;
    }

    #loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }

    .prediction-result {
      display: none;
      margin-top: 20px;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .prediction-up {
      background-color: rgba(46, 204, 113, 0.2);
      border: 1px solid var(--success-color);
    }

    .prediction-down {
      background-color: rgba(231, 76, 60, 0.2);
      border: 1px solid var(--danger-color);
    }

    #predictionResult {
      font-size: 1.1rem;
      line-height: 1.6;
    }

    .alert {
      background-color: var(--card-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-bright);
    }

    .alert-danger {
      background-color: rgba(231, 76, 60, 0.2);
      border-color: var(--danger-color);
    }

    .prediction-card {
      background: rgba(45, 45, 45, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
    }

    .prediction-value {
      font-size: 2.5rem;
      font-weight: 300;
      color: var(--text-highlight);
    }

    .prediction-label {
      color: var(--text-dim);
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .prediction-detail {
      color: var(--text-bright);
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }

    .chart-title {
      color: var(--text-highlight);
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }

    #stockChart {
      transition: all 0.3s ease;
    }

    .card.bg-dark {
      background: rgba(45, 45, 45, 0.7) !important;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .summary-card {
      padding: 1.5rem;
      text-align: center;
      height: 100%;
      transition: all 0.3s ease;
    }

    .summary-card:hover {
      transform: translateY(-5px);
      background: rgba(52, 152, 219, 0.1);
    }

    .summary-title {
      color: var(--text-highlight);
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .summary-value {
      color: var(--text-bright);
      font-size: 2rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
    }

    .summary-subtitle {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    .text-success {
      color: var(--success-color) !important;
    }

    .text-danger {
      color: var(--danger-color) !important;
    }

    .navbar-brand {
      color: rgba(255, 255, 255, 0.9) !important;
    }

    .card-title {
      color: rgba(255, 255, 255, 0.8);
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark px-4 mb-4">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <img src="logo.svg" width="40" height="40" class="d-inline-block align-top me-2" alt="StockTrendAI Logo">
        <span class="fs-4">StockTrendAI</span>
      </a>
      <span class="navbar-text">
        <i class="fas fa-robot me-2"></i>AI-Powered Stock Analysis
      </span>
    </div>
  </nav>

  <!-- Loading Spinner -->
  <div id="loading" class="text-center">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <!-- Stock Prediction Form -->
        <div class="card mb-4">
          <div class="card-body">
            <h4 class="card-title mb-4">
              <i class="fas fa-chart-line me-2"></i>Stock Forecast
            </h4>
            <form id="stockForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="symbol" class="form-label">Stock Symbol</label>
                    <div class="input-group">
                      <span class="input-group-text"><i class="fas fa-search"></i></span>
                      <input type="text" class="form-control" id="symbol" placeholder="e.g., AAPL, TSLA, NVDA" required>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="model" class="form-label">Prediction Model</label>
                    <select class="form-select" id="model" required>
                      <option value="logistic">Logistic Regression</option>
                      <option value="linear">Linear Regression</option>
                      <option value="rf">Random Forest</option>
                      <option value="xgboost">XGBoost</option>
                      <option value="lstm">LSTM Neural Network</option>
                      <option value="arima">ARIMA Time Series</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="year" class="form-label">End Year</label>
                    <input type="number" 
                           class="form-control" 
                           id="year" 
                           placeholder="e.g., 2024"
                           min="2000"
                           max="2025"
                           value="2024">
                  </div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-magic me-2"></i>Generate Prediction
              </button>
              <div class="mt-2 small text-center" style="color: rgba(255, 255, 255, 0.25);">
                <i class="fas fa-info-circle me-1"></i>
                Note: Historical data is only available from 2018 onwards. Predictions for earlier periods are not supported.
              </div>
            </form>
          </div>
        </div>

        <!-- Prediction Result -->
        <div id="predictionResult" class="prediction-result">
          <!-- Will be populated by JavaScript -->
        </div>

        <!-- Prediction Summary -->
        <div class="chart-container">
          <h5 class="mb-4">
            <i class="fas fa-chart-pie me-2"></i>Prediction Summary
          </h5>
          <div class="row g-4">
            <div class="col-md-4">
              <div class="card bg-dark">
                <div class="summary-card">
                  <h6 class="summary-title">Success Rate</h6>
                  <div class="summary-value">85%</div>
                  <div class="summary-subtitle">Based on historical predictions</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-dark">
                <div class="summary-card">
                  <h6 class="summary-title">Market Sentiment</h6>
                  <div class="summary-value">
                    <i class="fas fa-arrow-trend-up text-success"></i>
                  </div>
                  <div class="summary-subtitle">Bullish trend detected</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-dark">
                <div class="summary-card">
                  <h6 class="summary-title">Risk Level</h6>
                  <div class="summary-value">Medium</div>
                  <div class="summary-subtitle">Based on volatility analysis</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    document.getElementById('stockForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Show loading spinner
      document.getElementById('loading').style.display = 'block';
      
      // Get form values
      const ticker = document.getElementById('symbol').value.trim().toUpperCase();
      const model = document.getElementById('model').value;
      const year = document.getElementById('year').value;

      // Create FormData object
      const formData = new FormData();
      formData.append('ticker', ticker);
      formData.append('model', model);
      if (year) formData.append('end_year', year);

      try {
        console.log('Sending request with data:', {
          ticker,
          model,
          end_year: year
        });

        const response = await fetch('http://localhost:5000/predict', {
          method: 'POST',
          body: formData
        });

        const resultDiv = document.getElementById('predictionResult');
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Server response:', errorText);
          
          // Parse error message
          let errorMessage;
          try {
            const errorJson = JSON.parse(errorText);
            errorMessage = errorJson.error;
          } catch (e) {
            errorMessage = 'Server error occurred';
          }

          // Make error message more user-friendly
          if (errorMessage.includes('Could not verify ticker')) {
            errorMessage = 'Invalid stock symbol. Please check the symbol and try again.';
          } else if (errorMessage.includes('Insufficient historical data')) {
            errorMessage = 'Not enough historical data available for this stock.';
          } else if (errorMessage.includes('No data available')) {
            errorMessage = 'No data available for this stock symbol. Please try another symbol.';
          }

          resultDiv.className = 'prediction-result';
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle me-2"></i>
              ${errorMessage}
            </div>
          `;
          throw new Error(errorMessage);
        }

        const data = await response.json();
        console.log('Prediction data:', data);
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        // Update prediction display
        resultDiv.className = `prediction-result prediction-${data.prediction === 1 ? 'up' : 'down'}`;
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div class="prediction-card p-4">
            <div class="row align-items-center">
              <div class="col-md-6 text-center mb-4 mb-md-0">
                <div class="prediction-label">Prediction for ${data.ticker}</div>
                <div class="prediction-value">
                  <i class="fas fa-arrow-${data.prediction === 1 ? 'up text-success' : 'down text-danger'} me-2"></i>
                  ${(data.confidence * 100).toFixed(1)}%
                </div>
                <div class="prediction-detail mt-2">
                  Confidence Level
                </div>
              </div>
              <div class="col-md-6 text-center">
                <div class="mb-3">
                  <div class="prediction-label">Current Price</div>
                  <div class="prediction-value">$${data.last_price.toFixed(2)}</div>
                </div>
                <div>
                  <div class="prediction-label">Price Change</div>
                  <div class="prediction-detail ${data.price_change >= 0 ? 'text-success' : 'text-danger'}">
                    ${data.price_change >= 0 ? '+' : ''}${data.price_change.toFixed(2)}
                    <small>(${data.price_change_percent.toFixed(2)}%)</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Scroll to prediction result
        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

      } catch (error) {
        console.error('Error details:', error);
        const resultDiv = document.getElementById('predictionResult');
        resultDiv.className = 'prediction-result';
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            ${error.message}
          </div>
        `;
      } finally {
        // Hide loading spinner
        document.getElementById('loading').style.display = 'none';
      }
    });

    // Available stocks will be populated from backend
    let availableStocks = [];

    // Fetch available stocks from backend
    async function fetchAvailableStocks() {
      try {
        const response = await fetch('http://localhost:5000/available_stocks');
        if (!response.ok) throw new Error('Failed to fetch available stocks');
        const stocks = await response.json();
        
        // Map stocks to objects with symbol and name
        availableStocks = stocks.map(symbol => ({
          symbol,
          name: getCompanyName(symbol) // You can add a mapping of company names if needed
        }));
        
        console.log('Available stocks:', availableStocks);
      } catch (error) {
        console.error('Error fetching stocks:', error);
      }
    }

    // Get company name (you can expand this with actual company names)
    function getCompanyName(symbol) {
      const commonNames = {
        'AAPL': 'Apple Inc.',
        'GOOGL': 'Alphabet Inc.',
        'MSFT': 'Microsoft Corporation',
        'AMZN': 'Amazon.com Inc.',
        'META': 'Meta Platforms Inc.',
        'TSLA': 'Tesla, Inc.',
        'NVDA': 'NVIDIA Corporation',
        'JPM': 'JPMorgan Chase & Co.',
        'V': 'Visa Inc.',
        'WMT': 'Walmart Inc.'
      };
      return commonNames[symbol] || symbol;
    }

    // Add suggestions container after symbol input
    const symbolInput = document.getElementById('symbol');
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'stock-suggestions';
    suggestionsContainer.style.display = 'none';
    symbolInput.parentNode.appendChild(suggestionsContainer);

    // Filter and show suggestions
    symbolInput.addEventListener('input', function(e) {
      const value = e.target.value.toUpperCase();
      if (value.length < 1) {
        suggestionsContainer.style.display = 'none';
        return;
      }

      const matches = availableStocks.filter(stock => 
        stock.symbol.includes(value) || 
        stock.name.toUpperCase().includes(value)
      );

      if (matches.length > 0) {
        suggestionsContainer.innerHTML = matches.map(stock => `
          <div class="suggestion-item" data-symbol="${stock.symbol}">
            <span class="suggestion-symbol">${stock.symbol}</span>
            <span class="suggestion-name">${stock.name}</span>
          </div>
        `).join('');
        suggestionsContainer.style.display = 'block';
      } else {
        suggestionsContainer.style.display = 'none';
      }
    });

    // Handle suggestion selection
    suggestionsContainer.addEventListener('click', function(e) {
      const item = e.target.closest('.suggestion-item');
      if (item) {
        symbolInput.value = item.dataset.symbol;
        suggestionsContainer.style.display = 'none';
        // Auto-predict when symbol is selected
        document.getElementById('stockForm').dispatchEvent(new Event('submit'));
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#symbol') && !e.target.closest('.stock-suggestions')) {
        suggestionsContainer.style.display = 'none';
      }
    });

    // Auto-predict when year changes
    document.getElementById('year').addEventListener('change', function() {
      if (symbolInput.value) {
        document.getElementById('stockForm').dispatchEvent(new Event('submit'));
      }
    });

    // Set default year to current year + 1
    document.getElementById('year').value = new Date().getFullYear() + 1;

    // Fetch available stocks when page loads
    window.onload = async () => {
      await fetchAvailableStocks();
    };
  </script>
</body>
</html>